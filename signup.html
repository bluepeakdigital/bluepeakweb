<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign Up â€” BluePeak Digital</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="nav-slot"></div>

  <main class="section">
    <div class="container" style="max-width:520px;">
      <h2 class="section-title">Create Account</h2>
      <p class="section-lead">Sign up to request services and track progress.</p>

      <!-- Google sign-in -->
      <button class="btn btn-primary" id="googleBtn" type="button" style="width:100%; margin-bottom:12px;">
        Sign in with Google
      </button>

      <div style="text-align:center; opacity:.7; margin:10px 0;">or</div>

      <form class="form" id="signupForm">
        <label>Full Name
          <input name="full_name" type="text" minlength="2" maxlength="80" required />
        </label>

        <label>Email
          <input name="email" type="email" required />
        </label>

        <label>Phone Number (Required)
          <input name="phone" type="tel" placeholder="+679 9000000" minlength="7" maxlength="20" required />
        </label>

        <label>Company Name (Optional)
          <input name="company" type="text" maxlength="80" />
        </label>

        <label>Password
          <input name="password" type="password" minlength="8" maxlength="72" required />
        </label>

        <label style="display:flex; gap:10px; align-items:center;">
          <input name="agree" type="checkbox" required />
          I agree to the Terms & Privacy Policy
        </label>

        <button class="btn btn-primary" type="submit">Create Account</button>

        <p class="form-note">
          Already have an account?
          <a href="login.html" style="color:var(--accent);font-weight:800;">Login</a>
        </p>
      </form>
    </div>
  </main>

  <script src="./config.js"></script>

  <!-- Supabase client (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const API = (window.BP_API_BASE || "https://bluepeakweb.onrender.com").replace(/\/$/, "");

    // ---------- Client-side validation helpers ----------
    function isStrongEnough(pw) {
      // Basic rules: >= 8 and at least 1 letter + 1 number
      if (!pw || pw.length < 8) return false;
      const hasLetter = /[A-Za-z]/.test(pw);
      const hasNumber = /\d/.test(pw);
      return hasLetter && hasNumber;
    }

    function normalizePhone(p) {
      return (p || "").trim();
    }

    // ---------- Email/password signup ----------
    document.getElementById("signupForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());

      payload.full_name = (payload.full_name || "").trim();
      payload.email = (payload.email || "").trim();
      payload.phone = normalizePhone(payload.phone);
      payload.company = (payload.company || "").trim();
      payload.agree = !!payload.agree;

      // Frontend checks
      if (payload.full_name.length < 2) return alert("Full name must be at least 2 characters.");
      if (!payload.email.includes("@")) return alert("Please enter a valid email.");
      if (payload.phone.length < 7) return alert("Phone number is too short.");
      if (payload.phone.length > 20) return alert("Phone number is too long.");
      if (!isStrongEnough(payload.password)) return alert("Password must be 8+ chars and include letters + numbers.");
      if (!payload.agree) return alert("You must agree to the Terms & Privacy Policy.");

      try {
        const res = await fetch(`${API}/auth/signup`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const text = await res.text();
        let data = {};
        try { data = JSON.parse(text); } catch {}

        if (!res.ok || !data.ok) {
          return alert(`Signup failed (${res.status}) - ${data.error || text || "Unknown error"}`);
        }

        alert("Account created! Now login.");
        window.location.href = "login.html";
      } catch (err) {
        console.error(err);
        alert("Signup failed - Network error (check API URL/CORS)");
      }
    });

    // ---------- Google Sign-in ----------
    document.getElementById("googleBtn").addEventListener("click", async () => {
      const SUPABASE_URL = window.SUPABASE_URL;
      const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;

      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        return alert("Supabase keys missing in config.js");
      }

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const redirectTo = `${window.location.origin}/google-callback.html`;

      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo }
      });

      if (error) {
        console.error(error);
        alert("Google sign-in failed. Check Supabase Google provider settings.");
      }
    });
  </script>
</body>
</html>
