<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Welcome — BluePeak Digital</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="nav-slot"></div>

  <main class="section" style="background:#f6f8fc;color:#222;">
    <div class="container portal-container" style="max-width:900px;">
      <div class="dash-head" style="background:#fff;border-radius:16px;padding:18px 24px;margin-bottom:24px;box-shadow:0 2px 16px rgba(58,160,255,.08);display:flex;align-items:center;justify-content:space-between;">
        <div>
          <h2 class="section-title" id="welcome" style="color:#222;">Welcome</h2>
          <p class="section-lead" style="color:#555;">Your customer portal — manage requests, profile, and more.</p>
        </div>
        <div class="user-dropdown" style="position:relative;">
          <button class="btn btn-ghost" id="userMenuBtn" type="button" style="color:#222;background:#f6f8fc;border:1px solid #eaf2ff;">Account ▼</button>
          <div id="userMenu" style="display:none;position:absolute;right:0;top:calc(100% + 4px);background:#fff;border-radius:12px;box-shadow:0 2px 16px rgba(58,160,255,.12);padding:12px 0;min-width:140px;z-index:10;">
            <a href="#profile" class="dropdown-item" style="display:block;padding:10px 18px;color:#222;text-decoration:none;">Profile</a>
            <button class="dropdown-item" id="logoutBtn" type="button" style="width:100%;background:none;border:none;padding:10px 18px;text-align:left;color:#c00;cursor:pointer;">Logout</button>
          </div>
        </div>
      </div>

      <div class="tabs" style="display:flex;gap:12px;margin-bottom:24px;">
        <button class="tab-btn active" data-tab="request" style="background:#fff;color:#222;border:1px solid #eaf2ff;padding:12px 24px;border-radius:12px;font-weight:700;cursor:pointer;">Submit Request</button>
        <button class="tab-btn" data-tab="myrequests" style="background:#fff;color:#222;border:1px solid #eaf2ff;padding:12px 24px;border-radius:12px;font-weight:700;cursor:pointer;">My Requests</button>
        <button class="tab-btn" data-tab="profile" style="background:#fff;color:#222;border:1px solid #eaf2ff;padding:12px 24px;border-radius:12px;font-weight:700;cursor:pointer;">Profile</button>
      </div>

      <section class="panel tab-panel" id="tab-request" style="background:#fff;border-radius:16px;padding:24px;box-shadow:0 2px 16px rgba(58,160,255,.08);">
        <h3 class="panel-title" style="color:#222;">Request a Job / Service</h3>
        <p class="panel-sub" style="color:#555;">Fill this form carefully — it goes straight to admin.</p>
        <form class="form" id="reqForm">
          <label>Service Type
            <select name="service_type" required style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;">
              <option value="" disabled selected>Select</option>
              <option value="web">Web Development</option>
              <option value="design">Graphic Design</option>
              <option value="marketing">Digital Marketing</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>Title
            <input name="title" type="text" required maxlength="80" placeholder="e.g., Website for my business" style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;" />
          </label>
          <label>Details
            <textarea name="details" rows="6" required maxlength="2000" placeholder="Explain what you need, pages, content, deadline, etc." style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;"></textarea>
          </label>
          <div class="form-row">
            <label>Budget Min (optional)
              <input name="budget_min" type="number" min="0" style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;" />
            </label>
            <label>Budget Max (optional)
              <input name="budget_max" type="number" min="0" style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;" />
            </label>
          </div>
          <label>Deadline (optional)
            <input name="deadline" type="date" style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;" />
          </label>
          <button class="btn btn-primary" type="submit">Submit Request</button>
        </form>
      </section>

      <section class="panel tab-panel" id="tab-myrequests" style="background:#fff;border-radius:16px;padding:24px;box-shadow:0 2px 16px rgba(58,160,255,.08);display:none;transition:all .4s cubic-bezier(.4,0,.2,1);">
        <div class="panel-top">
          <div>
            <h3 class="panel-title" style="color:#222;">My Requests</h3>
            <p class="panel-sub" style="color:#555;">Your submitted requests show here.</p>
          </div>
          <button class="btn btn-ghost" id="refreshBtn" type="button" style="color:#222;background:#f6f8fc;border:1px solid #eaf2ff;">Refresh</button>
        </div>
        <div id="empty" class="empty">Loading...</div>
        <div id="list" class="req-list" style="display:none;gap:18px;"></div>
      </section>

      <section class="panel tab-panel" id="tab-profile" style="background:#fff;border-radius:16px;padding:24px;box-shadow:0 2px 16px rgba(58,160,255,.08);display:none;transition:all .4s cubic-bezier(.4,0,.2,1);">
        <h3 class="panel-title" style="color:#222;">Profile</h3>
        <p class="panel-sub" style="color:#555;">Update your account details below.</p>
        <form id="profileForm" style="margin-top:18px;color:#222;background:#f6f8fc;padding:18px;border-radius:12px;border:1px solid #eaf2ff;max-width:420px;">
          <label>Name
            <input name="name" id="profileNameInput" type="text" required style="background:#fff;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;" />
          </label>
          <label>Email
            <input name="email" id="profileEmailInput" type="email" required style="background:#fff;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;" />
          </label>
          <label>Password <span style="color:#888;font-weight:400;font-size:12px;">(leave blank to keep current)</span>
            <input name="password" id="profilePasswordInput" type="password" style="background:#fff;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;" />
          </label>
          <button class="btn btn-primary" type="submit" style="margin-top:10px;">Update Profile</button>
          <div id="profileMsg" style="margin-top:10px;font-weight:600;"></div>
        </form>
      </section>
    </div>
  </main>

  <script src="./config.js?v=9"></script>
  <script src="./app.js"></script>
  <script>
    const API = (window.BP_API_BASE || "https://bluepeakweb.onrender.com").replace(/\/$/, "");
    const token = localStorage.getItem("bp_token");
    const name = localStorage.getItem("bp_name") || "";
    const email = localStorage.getItem("bp_email") || "";
    const role = localStorage.getItem("bp_role") || "customer";

    if (!token) window.location.href = "login.html";
    document.getElementById("welcome").textContent = name ? `Welcome, ${name}` : "Welcome";

    // Dropdown menu
    const userMenuBtn = document.getElementById("userMenuBtn");
    const userMenu = document.getElementById("userMenu");
    userMenuBtn.onclick = (e) => {
      userMenu.style.display = userMenu.style.display === "block" ? "none" : "block";
      userMenuBtn.classList.toggle("active");
    };
    document.addEventListener("click", (e) => {
      if (!userMenu.contains(e.target) && e.target !== userMenuBtn) {
        userMenu.style.display = "none";
        userMenuBtn.classList.remove("active");
      }
    });

    document.getElementById("logoutBtn").onclick = () => {
      localStorage.removeItem("bp_token");
      localStorage.removeItem("bp_role");
      localStorage.removeItem("bp_name");
      localStorage.removeItem("bp_email");
      window.location.href = "login.html";
    };

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = function() {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.tab-panel').forEach(p=>p.style.display='none');
        document.getElementById('tab-'+this.dataset.tab).style.display='block';
      };
    });
    // Animate tab panels
    document.querySelectorAll('.tab-panel').forEach(panel => {
      panel.style.transition = 'opacity .4s cubic-bezier(.4,0,.2,1), transform .4s cubic-bezier(.4,0,.2,1)';
      panel.style.opacity = 0;
      panel.style.transform = 'translateY(24px)';
    });
    function showTab(tab) {
      document.querySelectorAll('.tab-panel').forEach(p=>{
        p.style.display='none'; p.style.opacity=0; p.style.transform='translateY(24px)';
      });
      const el = document.getElementById('tab-'+tab);
      el.style.display='block';
      setTimeout(()=>{
        el.style.opacity=1; el.style.transform='none';
      },10);
    }
    showTab('request');
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.onclick = function(){
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        this.classList.add('active');
        showTab(this.dataset.tab);
      };
    });

    // Escape HTML
    function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    // Load My Requests with actions
    async function loadMine() {
      const empty = document.getElementById("empty");
      const list = document.getElementById("list");
      empty.style.display = "block";
      list.style.display = "none";
      empty.textContent = "Loading...";

      const res = await fetch(`${API}/requests/mine`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      const data = await res.json().catch(()=>null);
      if (!res.ok || !data?.ok) {
        empty.textContent = "Failed to load requests.";
        return;
      }

      const items = data.requests || [];
      if (!items.length) {
        empty.textContent = "No requests yet.";
        return;
      }

      empty.style.display = "none";
      list.style.display = "grid";
      list.innerHTML = items.map(r => `
        <div class="req-card" style="background:#f6f8fc;border-radius:14px;padding:18px 20px;box-shadow:0 2px 12px rgba(58,160,255,.06);transition:box-shadow .3s;position:relative;overflow:hidden;">
          <div class="req-row" style="display:flex;align-items:center;justify-content:space-between;">
            <div class="req-title" style="font-weight:800;font-size:18px;color:#1d3557;">${esc(r.title)}</div>
            <span class="status status-${esc((r.status||"new").toLowerCase())}" style="font-weight:700;padding:4px 12px;border-radius:8px;background:#eaf2ff;color:#3aa0ff;">${esc(r.status||"new")}</span>
          </div>
          <div class="req-meta" style="color:#555;font-size:13px;margin:6px 0 10px;">
            <span>${esc(r.service_type)}</span><span>•</span>
            <span>${new Date(r.created_at).toLocaleString()}</span>
          </div>
          <div class="req-details" style="color:#333;font-size:15px;margin-bottom:10px;">${esc((r.details||"").slice(0,180))}${(r.details||"").length>180?"…":""}</div>
          <div class="req-actions" style="display:flex;gap:10px;">
            <button class="btn btn-ghost view-btn" data-id="${r.id}" style="color:#3aa0ff;border:1px solid #3aa0ff;background:#fff;">View</button>
            <button class="btn btn-ghost edit-btn" data-id="${r.id}" style="color:#1d5cff;border:1px solid #1d5cff;background:#fff;">Edit</button>
            <button class="btn btn-ghost delete-btn" data-id="${r.id}" style="color:#c00;border:1px solid #c00;background:#fff;">Delete</button>
          </div>
        </div>
      `).join("");

      // Animate cards
      document.querySelectorAll('.req-card').forEach((card,i)=>{
        card.style.opacity=0; card.style.transform='translateY(24px)';
        setTimeout(()=>{card.style.opacity=1;card.style.transform='none';},100+60*i);
      });

      // Action handlers (View/Edit/Delete)
      list.querySelectorAll('.view-btn').forEach(btn=>{
        btn.onclick = ()=>{
          alert('View details coming soon!');
        };
      });
      list.querySelectorAll('.edit-btn').forEach(btn=>{
        btn.onclick = ()=>{
          alert('Edit request coming soon!');
        };
      });
      list.querySelectorAll('.delete-btn').forEach(btn=>{
        btn.onclick = async ()=>{
          if(confirm('Delete this request?')){
            const res = await fetch(`${API}/requests/${btn.dataset.id}`,{
              method:'DELETE',headers:{Authorization:`Bearer ${token}`}
            });
            if(res.ok) loadMine();
            else alert('Failed to delete.');
          }
        };
      });
    }
    document.getElementById("refreshBtn").onclick = loadMine;

    document.getElementById("reqForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      if (payload.budget_min === "") delete payload.budget_min;
      if (payload.budget_max === "") delete payload.budget_max;
      const res = await fetch(`${API}/requests`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>null);
      if (!res.ok || !data?.ok) {
        return alert(`Request failed (${res.status}) - ${(data && data.error) ? data.error : "Server error"}`);
      }
      alert("Request submitted!");
      e.target.reset();
      loadMine();
    });

    // Profile tab: load and update
    function loadProfile() {
      document.getElementById('profileNameInput').value = name;
      document.getElementById('profileEmailInput').value = email;
      document.getElementById('profilePasswordInput').value = '';
      document.getElementById('profileMsg').textContent = '';
    }
    loadProfile();
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      if (!payload.password) delete payload.password;
      const res = await fetch(`${API}/auth/profile`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>null);
      const msg = document.getElementById('profileMsg');
      if (!res.ok || !data?.ok) {
        msg.textContent = `Update failed: ${(data && data.error) ? data.error : 'Server error'}`;
        msg.style.color = '#c00';
      } else {
        msg.textContent = 'Profile updated!';
        msg.style.color = '#1d5cff';
        if (payload.name) localStorage.setItem('bp_name', payload.name);
        if (payload.email) localStorage.setItem('bp_email', payload.email);
        loadProfile();
      }
    });

    // Animate profile form
    const profileForm = document.getElementById('profileForm');
    profileForm.style.transition = 'box-shadow .3s, transform .3s';
    profileForm.onfocusin = () => { profileForm.style.boxShadow = '0 4px 24px rgba(58,160,255,.13)'; profileForm.style.transform = 'scale(1.02)'; };
    profileForm.onfocusout = () => { profileForm.style.boxShadow = ''; profileForm.style.transform = ''; };

    // Initial load
    loadMine();
  </script>
</body>
</html>
