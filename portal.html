<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Welcome — BluePeak Digital</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="nav-slot"></div>

  <main class="section" style="background:#f6f8fc;color:#222;">
    <div class="container portal-container" style="max-width:900px;">
      <div class="dash-head" style="background:#fff;border-radius:16px;padding:18px 24px;margin-bottom:24px;box-shadow:0 2px 16px rgba(58,160,255,.08);display:flex;align-items:center;justify-content:space-between;">
        <div>
          <h2 class="section-title" id="welcome" style="color:#222;">Welcome</h2>
          <p class="section-lead" style="color:#555;">Your customer portal — manage requests, profile, and more.</p>
        </div>
        <div class="user-dropdown" style="position:relative;">
          <button class="btn btn-ghost" id="userMenuBtn" type="button" style="color:#222;background:#f6f8fc;border:1px solid #eaf2ff;">Account ▼</button>
          <div id="userMenu" style="display:none;position:absolute;right:0;top:calc(100% + 4px);background:#fff;border-radius:12px;box-shadow:0 2px 16px rgba(58,160,255,.12);padding:12px 0;min-width:140px;z-index:10;">
            <a href="#profile" class="dropdown-item" style="display:block;padding:10px 18px;color:#222;text-decoration:none;">Profile</a>
            <button class="dropdown-item" id="logoutBtn" type="button" style="width:100%;background:none;border:none;padding:10px 18px;text-align:left;color:#c00;cursor:pointer;">Logout</button>
          </div>
        </div>
      </div>

      <div class="tabs" style="display:flex;gap:12px;margin-bottom:24px;">
        <button class="tab-btn active" data-tab="request" style="background:#fff;color:#222;border:1px solid #eaf2ff;padding:12px 24px;border-radius:12px;font-weight:700;cursor:pointer;">Submit Request</button>
        <button class="tab-btn" data-tab="myrequests" style="background:#fff;color:#222;border:1px solid #eaf2ff;padding:12px 24px;border-radius:12px;font-weight:700;cursor:pointer;">My Requests</button>
        <button class="tab-btn" data-tab="profile" style="background:#fff;color:#222;border:1px solid #eaf2ff;padding:12px 24px;border-radius:12px;font-weight:700;cursor:pointer;">Profile</button>
      </div>

      <section class="panel tab-panel" id="tab-request" style="background:#fff;border-radius:16px;padding:24px;box-shadow:0 2px 16px rgba(58,160,255,.08);">
        <h3 class="panel-title" style="color:#222;">Request a Job / Service</h3>
        <p class="panel-sub" style="color:#555;">Fill this form carefully — it goes straight to admin.</p>
        <form class="form" id="reqForm">
          <label>Service Type
            <select name="service_type" required style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;">
              <option value="" disabled selected>Select</option>
              <option value="web">Web Development</option>
              <option value="design">Graphic Design</option>
              <option value="marketing">Digital Marketing</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>Title
            <input name="title" type="text" required maxlength="80" placeholder="e.g., Website for my business" style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;" />
          </label>
          <label>Details
            <textarea name="details" rows="6" required maxlength="2000" placeholder="Explain what you need, pages, content, deadline, etc." style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;"></textarea>
          </label>
          <div class="form-row">
            <label>Budget Min (optional)
              <input name="budget_min" type="number" min="0" style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;" />
            </label>
            <label>Budget Max (optional)
              <input name="budget_max" type="number" min="0" style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;" />
            </label>
          </div>
          <label>Deadline (optional)
            <input name="deadline" type="date" style="background:#f6f8fc;color:#222;border:1px solid #eaf2ff;padding:8px 12px;border-radius:8px;" />
          </label>
          <button class="btn btn-primary" type="submit">Submit Request</button>
        </form>
      </section>

      <section class="panel tab-panel" id="tab-myrequests" style="background:#fff;border-radius:16px;padding:24px;box-shadow:0 2px 16px rgba(58,160,255,.08);display:none;">
        <div class="panel-top">
          <div>
            <h3 class="panel-title" style="color:#222;">My Requests</h3>
            <p class="panel-sub" style="color:#555;">Your submitted requests show here.</p>
          </div>
          <button class="btn btn-ghost" id="refreshBtn" type="button" style="color:#222;background:#f6f8fc;border:1px solid #eaf2ff;">Refresh</button>
        </div>
        <div id="empty" class="empty">Loading...</div>
        <div id="list" class="req-list" style="display:none;"></div>
      </section>

      <section class="panel tab-panel" id="tab-profile" style="background:#fff;border-radius:16px;padding:24px;box-shadow:0 2px 16px rgba(58,160,255,.08);display:none;">
        <h3 class="panel-title" style="color:#222;">Profile</h3>
        <p class="panel-sub" style="color:#555;">View your account details here.</p>
        <div id="profileInfo" style="margin-top:18px;color:#222;background:#f6f8fc;padding:18px;border-radius:12px;border:1px solid #eaf2ff;">
          <strong>Name:</strong> <span id="profileName"></span><br>
          <strong>Email:</strong> <span id="profileEmail"></span><br>
          <strong>Role:</strong> <span id="profileRole"></span>
        </div>
      </section>
    </div>
  </main>

  <script src="./config.js?v=9"></script>
  <script src="./app.js"></script>
  <script>
    const API = (window.BP_API_BASE || "https://bluepeakweb.onrender.com").replace(/\/$/, "");
    const token = localStorage.getItem("bp_token");
    const name = localStorage.getItem("bp_name") || "";

    if (!token) window.location.href = "login.html";
    document.getElementById("welcome").textContent = name ? `Welcome, ${name}` : "Welcome";

    document.getElementById("logoutBtn").onclick = () => {
      localStorage.removeItem("bp_token");
      localStorage.removeItem("bp_role");
      localStorage.removeItem("bp_name");
      window.location.href = "login.html";
    };

    function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    async function loadMine() {
      const empty = document.getElementById("empty");
      const list = document.getElementById("list");
      empty.style.display = "block";
      list.style.display = "none";
      empty.textContent = "Loading...";

      const res = await fetch(`${API}/requests/mine`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      const data = await res.json().catch(()=>null);
      if (!res.ok || !data?.ok) {
        empty.textContent = "Failed to load requests.";
        return;
      }

      const items = data.requests || [];
      if (!items.length) {
        empty.textContent = "No requests yet.";
        return;
      }

      empty.style.display = "none";
      list.style.display = "grid";
      list.innerHTML = items.map(r => `
        <div class="req-card">
          <div class="req-row">
            <div class="req-title">${esc(r.title)}</div>
            <span class="status status-${esc((r.status||"new").toLowerCase())}">${esc(r.status||"new")}</span>
          </div>
          <div class="req-meta">
            <span>${esc(r.service_type)}</span><span>•</span>
            <span>${new Date(r.created_at).toLocaleString()}</span>
          </div>
          <div class="req-details">${esc((r.details||"").slice(0,180))}${(r.details||"").length>180?"…":""}</div>
        </div>
      `).join("");
    }

    document.getElementById("refreshBtn").onclick = loadMine;

    document.getElementById("reqForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());

      if (payload.budget_min === "") delete payload.budget_min;
      if (payload.budget_max === "") delete payload.budget_max;

      const res = await fetch(`${API}/requests`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(()=>null);
      if (!res.ok || !data?.ok) {
        return alert(`Request failed (${res.status}) - ${(data && data.error) ? data.error : "Server error"}`);
      }

      alert("Request submitted!");
      e.target.reset();
      loadMine();
    });

    loadMine();
  </script>
</body>
</html>
