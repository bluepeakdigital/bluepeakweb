<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Welcome — BluePeak Digital</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="nav-slot"></div>

  <main class="section">
    <div class="container" style="max-width:900px;">
      <div class="dash-head">
        <div>
          <h2 class="section-title" id="welcome">Welcome</h2>
          <p class="section-lead">Submit a request and our team will contact you.</p>
        </div>
        <button class="btn btn-ghost" id="logoutBtn" type="button">Logout</button>
      </div>

      <section class="panel">
        <h3 class="panel-title">Request a Job / Service</h3>
        <p class="panel-sub">Fill this form carefully — it goes straight to admin.</p>

        <form class="form" id="reqForm">
          <label>Service Type
            <select name="service_type" required>
              <option value="" disabled selected>Select</option>
              <option value="web">Web Development</option>
              <option value="design">Graphic Design</option>
              <option value="marketing">Digital Marketing</option>
              <option value="other">Other</option>
            </select>
          </label>

          <label>Title
            <input name="title" type="text" required maxlength="80" placeholder="e.g., Website for my business" />
          </label>

          <label>Details
            <textarea name="details" rows="6" required maxlength="2000"
              placeholder="Explain what you need, pages, content, deadline, etc."></textarea>
          </label>

          <div class="form-row">
            <label>Budget Min (optional)
              <input name="budget_min" type="number" min="0" />
            </label>
            <label>Budget Max (optional)
              <input name="budget_max" type="number" min="0" />
            </label>
          </div>

          <label>Deadline (optional)
            <input name="deadline" type="date" />
          </label>

          <button class="btn btn-primary" type="submit">Submit Request</button>
        </form>
      </section>

      <section class="panel" style="margin-top:16px;">
        <div class="panel-top">
          <div>
            <h3 class="panel-title">My Requests</h3>
            <p class="panel-sub">Your submitted requests show here.</p>
          </div>
          <button class="btn btn-ghost" id="refreshBtn" type="button">Refresh</button>
        </div>

        <div id="empty" class="empty">Loading...</div>
        <div id="list" class="req-list" style="display:none;"></div>
      </section>
    </div>
  </main>

  <script src="./config.js?v=9"></script>
  <script src="./app.js"></script>
  <script>
    const API = (window.BP_API_BASE || "https://bluepeakweb.onrender.com").replace(/\/$/, "");
    const token = localStorage.getItem("bp_token");
    const name = localStorage.getItem("bp_name") || "";

    if (!token) window.location.href = "login.html";
    document.getElementById("welcome").textContent = name ? `Welcome, ${name}` : "Welcome";

    document.getElementById("logoutBtn").onclick = () => {
      localStorage.removeItem("bp_token");
      localStorage.removeItem("bp_role");
      localStorage.removeItem("bp_name");
      window.location.href = "login.html";
    };

    function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    async function loadMine() {
      const empty = document.getElementById("empty");
      const list = document.getElementById("list");
      empty.style.display = "block";
      list.style.display = "none";
      empty.textContent = "Loading...";

      const res = await fetch(`${API}/requests/mine`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      const data = await res.json().catch(()=>null);
      if (!res.ok || !data?.ok) {
        empty.textContent = "Failed to load requests.";
        return;
      }

      const items = data.requests || [];
      if (!items.length) {
        empty.textContent = "No requests yet.";
        return;
      }

      empty.style.display = "none";
      list.style.display = "grid";
      list.innerHTML = items.map(r => `
        <div class="req-card">
          <div class="req-row">
            <div class="req-title">${esc(r.title)}</div>
            <span class="status status-${esc((r.status||"new").toLowerCase())}">${esc(r.status||"new")}</span>
          </div>
          <div class="req-meta">
            <span>${esc(r.service_type)}</span><span>•</span>
            <span>${new Date(r.created_at).toLocaleString()}</span>
          </div>
          <div class="req-details">${esc((r.details||"").slice(0,180))}${(r.details||"").length>180?"…":""}</div>
        </div>
      `).join("");
    }

    document.getElementById("refreshBtn").onclick = loadMine;

    document.getElementById("reqForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());

      if (payload.budget_min === "") delete payload.budget_min;
      if (payload.budget_max === "") delete payload.budget_max;

      const res = await fetch(`${API}/requests`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(()=>null);
      if (!res.ok || !data?.ok) {
        return alert(`Request failed (${res.status}) - ${(data && data.error) ? data.error : "Server error"}`);
      }

      alert("Request submitted!");
      e.target.reset();
      loadMine();
    });

    loadMine();
  </script>
</body>
</html>
